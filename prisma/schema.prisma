// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  SALES
  PROCUREMENT
  FINANCE
  ADMIN
}

enum CompanyType {
  PROSPECT
  CLIENT
  VENDOR
  PARTNER
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
}

enum InteractionStatus {
  FOLLOW_UP_SCHEDULED
  CLOSED
}

enum OpportunityStatus {
  OPEN
  QUALIFICATION    // NEW
  PROPOSAL         // NEW
  NEGOTIATION      // NEW
  CLOSED_WON
  CLOSED_LOST
  FULFILLED
}

enum ProjectStatus {
  SOURCING
  COMPLETED
}

enum SampleStatus {
  REQUESTED
  SENT
  RECEIVED
  UNDER_REVIEW
  Result_APPROVED_INTERNAL // "Internal Approved"
  SENT_TO_CLIENT           // "Sent to Client"
  CLIENT_APPROVED          // "Client Approved"
  CLIENT_REJECTED          // "Client Rejected"
  Result_REJECTED          // "Rejected" (Internal)
}

enum SalesOrderStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  IN_PROGRESS
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

enum InvoiceStatus {
  UNPAID
  PARTIAL
  PAID
}

enum BillStatus {
  DRAFT
  APPROVED
  PAID
}

enum TransactionType {
  CREDIT
  DEBIT
}

// Models

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          Role      @default(SALES)
  accounts      Account[]
  sessions      Session[]

  interactions InteractionLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit Logs
  createdCompanies Company[] @relation("CreatedBy")
  updatedCompanies Company[] @relation("UpdatedBy")
  createdOpportunities SalesOpportunity[] @relation("CreatedBy")
  updatedOpportunities SalesOpportunity[] @relation("UpdatedBy") 
  createdProjects ProcurementProject[] @relation("CreatedBy")
  updatedProjects ProcurementProject[] @relation("UpdatedBy")
  createdSamples SampleRecord[] @relation("CreatedBy")
  updatedSamples SampleRecord[] @relation("UpdatedBy")
  createdOrders SalesOrder[] @relation("CreatedBy")
  updatedOrders SalesOrder[] @relation("UpdatedBy")
  createdPurchaseOrders PurchaseOrder[] @relation("CreatedBy")
  updatedPurchaseOrders PurchaseOrder[] @relation("UpdatedBy")
  createdInvoices Invoice[] @relation("CreatedBy")
  updatedInvoices Invoice[] @relation("UpdatedBy")
  createdBills Bill[] @relation("CreatedBy")
  updatedBills Bill[] @relation("UpdatedBy")
  createdTransactions Transaction[] @relation("CreatedBy")
  updatedTransactions Transaction[] @relation("UpdatedBy")
  createdShipments Shipment[] @relation("CreatedBy")
  updatedShipments Shipment[] @relation("UpdatedBy")
  createdGRNs GRN[] @relation("CreatedBy")
  updatedGRNs GRN[] @relation("UpdatedBy")
  createdInteractions InteractionLog[] @relation("CreatedInteraction")
  updatedInteractions InteractionLog[] @relation("UpdatedInteraction")

  @@index([email])
  @@index([role])
  
  activities  ActivityLog[]
  todos       Todo[]
  assignedTasks Todo[] @relation("AssignedTasks")
  sourcingRequests SourcingRequest[]
  notifications Notification[]
  noteReplies NoteReply[]
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   // Recipient
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}

model ActivityLog {
  id          String   @id @default(uuid())
  action      String   // e.g. "CREATE", "UPDATE", "STATUS_CHANGE"
  entityType  String   // e.g. "SalesOrder", "Invoice"
  entityId    String   
  entityTitle String?  // Human readable title e.g. "Order #123"
  details     String?  // Description of change
  userId      String
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
}

model EmailLog {
  id             String   @id @default(uuid())
  sentAt         DateTime @default(now())
  provider       String   // "RESEND" | "SES"
  recipientEmail String
  subject        String?
  body           String?  @db.Text
  campaignId     String?  // Optional grouping
}

model Account {
  id                 String  @id @default(uuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Invitation {
  id        String   @id @default(uuid())
  email     String   @unique
  token     String   @unique
  role      Role     @default(SALES)
  status    String   @default("PENDING") // PENDING, ACCEPTED
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TrustLevel {
  UNRATED
  LOW
  MEDIUM
  HIGH
  VERIFIED
}

model Company {
  id        String        @id @default(uuid())
  name      String
  type      CompanyType
  phone     String?
  email     String?
  website   String?   // NEW
  contactName String? // NEW
  country   Country? @relation(fields: [countryId], references: [id])
  countryId String?
  state     State?   @relation(fields: [stateId], references: [id])
  stateId   String?
  city      City?    @relation(fields: [cityId], references: [id])
  cityId    String?

  trustLevel TrustLevel   @default(UNRATED)
  status    CompanyStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  interactions      InteractionLog[]
  salesOpportunities SalesOpportunity[] // As Client/Prospect
  projectVendors    ProjectVendor[]    // As Vendor
  salesOrders       SalesOrder[]       // As Client
  purchaseOrders    PurchaseOrder[]    // As Vendor
  bills             Bill[]             // As Vendor
  sampleRecords     SampleRecord[]     // Samples provided
  commodities       Commodity[]
  vendorVarieties   VendorVariety[]

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([countryId])
  @@index([stateId])
  @@index([cityId])
}

model Country {
  id        String   @id @default(uuid())
  name      String   @unique
  states    State[]
  companies Company[]
}

model State {
  id        String   @id @default(uuid())
  name      String
  countryId String
  country   Country  @relation(fields: [countryId], references: [id])
  cities    City[]
  companies Company[]
  vendorVarieties VendorVariety[]

  @@unique([name, countryId])
}

model City {
  id        String   @id @default(uuid())
  name      String
  stateId   String
  state     State    @relation(fields: [stateId], references: [id])
  companies Company[]

  @@unique([name, stateId])
}

model Commodity {
   id        String    @id @default(uuid())
   name      String    @unique
   yieldPercentage Float @default(100.0) // Percentage yield (e.g. 25.0 for 25%)
   companies         Company[]
   salesOpportunities SalesOpportunity[]
   procurementProjects ProcurementProject[]
   varieties         CommodityVariety[] // NEW
   documentTemplate  Json?     // Stores { sections: [...] } for document generation
 }
 
 model CommodityVariety {
   id          String    @id @default(uuid())
   name        String
   commodityId String
   description String?
   
   commodity   Commodity @relation(fields: [commodityId], references: [id])
   vendorMappings VendorVariety[]
   
   @@unique([name, commodityId])
 }
 
 model VendorVariety {
   id            String    @id @default(uuid())
   vendorId      String
   varietyId     String
   originStateId String?
   
   leadTime      String?   // e.g. "3 days"
   supplyCapacity String?  // e.g. "50 MT/week"
   qualityGrade  String?   // e.g. "A", "Premium"
   isBlacklisted Boolean   @default(false)
   
   vendor        Company          @relation(fields: [vendorId], references: [id])
   variety       CommodityVariety @relation(fields: [varietyId], references: [id])
   originState   State?           @relation(fields: [originStateId], references: [id])
   
   @@unique([vendorId, varietyId])
 }
 
 enum SourcingRequestStatus {
   OPEN
   RESEARCH
   SAMPLING
   ONBOARDED
   UNAVAILABLE
 }
 
 enum Sourcingpriority {
   NORMAL
   URGENT
 }
 
 model SourcingRequest {
   id            String    @id @default(uuid())
   requestedItem String    // Name of commodity/variety
   volume        String?
   salesUserId   String
   status        SourcingRequestStatus @default(OPEN)
   priority      Sourcingpriority      @default(NORMAL)
   
   notes         String?
   createdAt     DateTime  @default(now())
   updatedAt     DateTime  @updatedAt
   
   salesUser     User      @relation(fields: [salesUserId], references: [id])
 }

model Product {
  id   String @id @default(uuid())
  name String @unique
}

model InteractionLog {
  id           String            @id @default(uuid())
  companyId    String
  userId       String
  description  String
  date         DateTime          @default(now())
  nextFollowUp DateTime?
  status       InteractionStatus @default(FOLLOW_UP_SCHEDULED)
  
  company Company @relation(fields: [companyId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt @default(now())
  createdById String?
  updatedById String?
  createdBy   User?    @relation("CreatedInteraction", fields: [createdById], references: [id])
  updatedBy   User?    @relation("UpdatedInteraction", fields: [updatedById], references: [id])

  @@index([companyId])
  @@index([userId])
  @@index([date])
}

enum OpportunityType {
  ONE_TIME
  RECURRING
}

enum RecurringFrequency {
  WEEKLY
  MONTHLY
}

enum OpportunityPriceType {
  PER_KG
  PER_MT
  TOTAL_AMOUNT
}

model SalesOpportunity {
  id                 String            @id @default(uuid())
  companyId          String
  productName        String
  targetPrice        Decimal?
  priceType          OpportunityPriceType @default(PER_KG)
  quantity           Decimal?
  procurementQuantity Decimal?       // Calculated raw material needed based on yield
  deadline           DateTime?
  status             OpportunityStatus @default(OPEN)
  type               OpportunityType   @default(ONE_TIME)
  recurringFrequency RecurringFrequency?
  notes              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  // Bridge to Procurement
  procurementProjectId String?

  company            Company             @relation(fields: [companyId], references: [id])
  procurementProject ProcurementProject? @relation(fields: [procurementProjectId], references: [id])
  commodity          Commodity?          @relation(fields: [commodityId], references: [id])
  commodityId        String?
  salesOrders        SalesOrder[]
  sampleSubmissions  SampleSubmission[]

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@index([companyId])
  @@index([commodityId])
  @@index([procurementProjectId])
  @@index([createdAt])
  @@index([status])
}

enum ProcurementType {
  PROJECT
  SAMPLE
}

model ProcurementProject {
  id        String        @id @default(uuid())
  name      String        // e.g. "Banana Powder Sourcing"
  type      ProcurementType @default(PROJECT)
  status    ProjectStatus @default(SOURCING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  salesOpportunities SalesOpportunity[]
  projectVendors     ProjectVendor[]
  samples            SampleRecord[]
  purchaseOrders     PurchaseOrder[]
  commodity          Commodity?    @relation(fields: [commodityId], references: [id])
  commodityId        String?

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
}

model ProjectVendor {
  id        String @id @default(uuid())
  projectId String
  vendorId  String

  project ProcurementProject @relation(fields: [projectId], references: [id])
  vendor  Company            @relation(fields: [vendorId], references: [id])

  @@unique([projectId, vendorId])
  @@index([projectId])
  @@index([vendorId])
}

model SampleRecord {
  id            String       @id @default(uuid())
  projectId     String
  vendorId      String
  receivedDate  DateTime?    // Changed to optional as it's not received yet
  notes         String?      // Instructions for the vendor (Requested notes)
  qualityNotes  String?      // Notes from procurement team (Visual inspection etc)
  feedback      String?      // Internal feedback/review notes
  qualityStats  Json?        // Stores structured data if needed
  priceQuoted   Decimal?
  priceUnit     OpportunityPriceType @default(PER_KG)
  images        String[]     @default([]) // Multi-image support
  qualityCertifications Json @default("[]") // NEW: Array of {name, url, type}
  status        SampleStatus @default(REQUESTED)

  project ProcurementProject @relation(fields: [projectId], references: [id])
  vendor  Company            @relation(fields: [vendorId], references: [id])

  purchaseOrders PurchaseOrder[] 
  submissions    SampleSubmission[]

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@index([projectId])
  @@index([vendorId])
}

model SampleSubmission {
  id            String       @id @default(uuid())
  sampleId      String
  opportunityId String
  status        SampleStatus @default(SENT_TO_CLIENT)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  sample      SampleRecord     @relation(fields: [sampleId], references: [id])
  opportunity SalesOpportunity @relation(fields: [opportunityId], references: [id])

  @@unique([sampleId, opportunityId])
}

model SalesOrder {
  id            String           @id @default(uuid())
  opportunityId String
  clientId      String
  totalAmount   Decimal
  status        SalesOrderStatus @default(CONFIRMED)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  fulfillmentNotes String?       // Notes explaining why order was closed/delivered if incomplete

  opportunity SalesOpportunity @relation(fields: [opportunityId], references: [id])
  client      Company          @relation(fields: [clientId], references: [id])
  invoices    Invoice[]
  transactions Transaction[]
  shipments   Shipment[]

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@index([opportunityId])
  @@index([clientId])
  @@index([createdAt])
}

model PurchaseOrder {
  id          String              @id @default(uuid())
  projectId   String
  vendorId    String
  sampleId    String? // Link to the approved sample
  quantity    Decimal? // NEW: Explicit quantity
  quantityUnit String? @default("MT") // NEW: Unit
  totalAmount Decimal
  status      PurchaseOrderStatus @default(DRAFT)
  pdfUrl      String? // URL to the attached PO PDF
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  project ProcurementProject @relation(fields: [projectId], references: [id])
  vendor  Company            @relation(fields: [vendorId], references: [id])
  sample  SampleRecord?      @relation(fields: [sampleId], references: [id])
  bills   Bill[]
  shipments Shipment[]
  grn       GRN?

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@index([projectId])
  @@index([vendorId])
  @@index([createdAt])
  @@index([status])
}

model Invoice {
  id            String        @id @default(uuid())
  salesOrderId  String
  totalAmount   Decimal
  pendingAmount Decimal
  dueDate       DateTime?
  status        InvoiceStatus @default(UNPAID)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  salesOrder SalesOrder    @relation(fields: [salesOrderId], references: [id])
  transactions Transaction[]

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@index([salesOrderId])
  @@index([createdAt])
  @@index([status])

}

model Bill {
  id              String     @id @default(uuid())
  purchaseOrderId String
  vendorId        String
  invoiceNumber   String?
  totalAmount     Decimal
  pendingAmount   Decimal    @default(0) // Will be initialized to totalAmount
  dueDate         DateTime?
  status          BillStatus @default(DRAFT)
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  vendor        Company       @relation(fields: [vendorId], references: [id])
  transactions  Transaction[]

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@index([purchaseOrderId])
  @@index([vendorId])
  @@index([createdAt])
}

model Transaction {
  id          String          @id @default(uuid())
  type        TransactionType
  amount      Decimal
  date        DateTime        @default(now())
  description String?
  category    String?
  receipts    String[]
  
  // Polymorphic-like relations (one should be set)
  invoiceId   String?
  billId      String?
  salesOrderId String? // Link expense directly to a deal

  invoice Invoice? @relation(fields: [invoiceId], references: [id])
  bill    Bill?    @relation(fields: [billId], references: [id])
  salesOrder SalesOrder? @relation(fields: [salesOrderId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
}

model Shipment {
  id              String   @id @default(uuid())
  purchaseOrderId String?   // Removed @unique to allow multiple, made optional for Polymorphism
  salesOrderId    String?

  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  salesOrder      SalesOrder?    @relation(fields: [salesOrderId], references: [id])

  carrier         String?
  trackingNumber  String?
  quantity        Decimal?
  eta             DateTime?
  status          String   @default("IN_TRANSIT")
  actualDeliveryDate DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
}

model GRN {
  id              String   @id @default(uuid())
  purchaseOrderId String   @unique // 1:1 for simplicity initially (Full receipt) or allow partials? Let's stick to 1:1 for this version as per plan (triggers RECEIVED).
  receivedDate    DateTime @default(now())
  receivedBy      String?
  
  // Quantities
  totalReceivedQuantity Decimal
  rejectedQuantity      Decimal @default(0)
  acceptedQuantity      Decimal // Calculated

  // Quality
  qualityCheckStatus String // PENDING, PASSED, FAILED
  notes              String?
  images             String[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([purchaseOrderId])
  @@index([createdAt])

  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
}

model Todo {
  id        String      @id @default(uuid())
  content   String
  type      TodoType    @default(NOTE) // NEW
  status    TodoStatus  @default(PENDING)
  priority  TodoPriority @default(MEDIUM)
  dueDate   DateTime?   // NEW
  
  userId    String
  user      User        @relation(fields: [userId], references: [id])

  assignedToId String?
  assignedTo   User?    @relation("AssignedTasks", fields: [assignedToId], references: [id])

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  replies   NoteReply[]
}

model NoteReply {
  id        String   @id @default(uuid())
  content   String
  todoId    String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  todo      Todo     @relation(fields: [todoId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
}

enum TodoStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum TodoPriority {
  LOW
  MEDIUM
  HIGH
}

enum TodoType {
  NOTE
  TASK
}
